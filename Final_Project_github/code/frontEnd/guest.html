<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲端檔案系統 - 主頁面</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
        }

        .header {
            background-color: white;
            padding: 15px 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            padding: 8px 15px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }

        .logout-btn:hover {
            background-color: #c82333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            border-bottom-color: #0066cc;
            color: #0066cc;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        h1,
        h2 {
            text-align: center;
            margin-bottom: 30px;
        }

        .upload-area {
            border: 2px dashed #ccc;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 5px;
            position: relative;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #0066cc;
            background-color: #f8f9ff;
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .upload-button {
            padding: 12px 24px;
            background-color: #0066cc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .upload-button:hover {
            background-color: #0056b3;
        }

        .image-preview {
            width: 100%;
            max-height: 300px;
            display: none;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 20px;
        }

        .upload-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            display: none;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #0066cc;
            border-radius: 50%;
            animation: spin 2s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .file-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .file-thumbnail {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background-color: #f8f9fa;
        }

        .file-info {
            padding: 15px;
        }

        .file-name {
            font-weight: bold;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .file-size {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            text-align: center;
            flex: 1;
        }

        .btn-primary {
            background-color: #0066cc;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: #ffc107;
            color: black;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .search-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .refresh-btn {
            padding: 10px 20px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .refresh-btn:hover {
            background-color: #138496;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state img {
            width: 100px;
            height: 100px;
            opacity: 0.3;
            margin-bottom: 20px;
        }

        .file-count {
            margin-bottom: 15px;
            color: #666;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90vw;
            max-height: 90vh;
        }

        .modal-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 35px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover {
            opacity: 0.7;
        }

        .disabled {
            pointer-events: none;
            opacity: 0.5;
        }
    </style>
</head>

<body>
    <div class="header">
        <div>
            <h2>雲端檔案系統</h2>
            <p>姓名：謝昊君 | 學號：S11059006</p>
        </div>
        <div class="user-info">
            <span>歡迎，<span id="username">使用者</span></span>
            <button class="logout-btn" onclick="logout()">登出</button>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('upload')">檔案上傳</button>
            <button class="tab" onclick="switchTab('view')">檔案管理</button>
        </div>

        <!-- 上傳分頁 -->
        <div id="upload-tab" class="tab-content active">
            <h1>檔案上傳</h1>
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" class="file-input" accept="image/*">
                <button class="upload-button" id="uploadBtn">選擇圖片</button>
                <p>或將圖片拖曳到這裡</p>
            </div>
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>上傳中，請稍候...</p>
            </div>
            <div class="upload-status" id="uploadStatus"></div>
            <img id="imagePreview" class="image-preview" alt="預覽圖">
        </div>

        <!-- 檔案管理分頁 -->
        <div id="view-tab" class="tab-content">
            <h1>檔案管理</h1>
            <div class="search-bar">
                <input type="text" id="searchInput" class="search-input" placeholder="搜尋檔案名稱...">
                <button class="refresh-btn" onclick="loadFiles()">重新整理</button>
            </div>
            <div class="file-count" id="fileCount">載入中...</div>
            <div class="files-grid" id="filesGrid">
                <div class="empty-state">
                    <div class="loading-spinner"></div>
                    <p>載入檔案中...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 圖片預覽模態框 -->
    <div id="imageModal" class="modal">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <div class="modal-content">
            <img id="modalImage" class="modal-image" alt="大圖預覽">
        </div>
    </div>

    <script>
        let currentUser = '';
        let allFiles = [];

        document.addEventListener('DOMContentLoaded', function () {
            // 檢查登入狀態
            checkLoginStatus();

            // 初始化上傳功能
            initializeUpload();

            // 初始化檔案管理
            loadFiles();

            // 搜尋功能
            document.getElementById('searchInput').addEventListener('input', filterFiles);
        });

        function checkLoginStatus() {
            const username = sessionStorage.getItem('username');
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');

            const guestMode = !isLoggedIn || !username;
            currentUser = username || '訪客';

            document.getElementById('username').textContent = currentUser;

            if (guestMode) {
                disableFunctionalityForGuest();
                showStatus('您目前是訪客，請登入以使用完整功能。', 'warning');
            }
        }
        function disableFunctionalityForGuest() {
            // 隱藏或停用上傳區
            const uploadArea = document.getElementById('uploadArea');
            const uploadBtn = document.getElementById('uploadBtn');
            uploadArea.classList.add('disabled');
            uploadBtn.disabled = true;

            // 隱藏檔案管理頁籤內容
            const filesGrid = document.getElementById('filesGrid');
            const fileCount = document.getElementById('fileCount');
            if (filesGrid) filesGrid.innerHTML = `<p>請登入以檢視您的檔案。</p>`;
            if (fileCount) fileCount.textContent = '';

            // 防止觸發 loadFiles
            loadFiles = () => { }; // 覆蓋成空函式
        }
        function logout() {
            sessionStorage.clear();
            localStorage.removeItem('rememberedUsername');
            alert('已成功登出！');
            window.location.href = 'login.html';
        }

        function switchTab(tabName) {
            // 更新標籤樣式
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');

            if (tabName === 'view') {
                loadFiles();
            }
        }

        function initializeUpload() {
            const fileInput = document.getElementById('fileInput');
            const imagePreview = document.getElementById('imagePreview');
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadArea = document.getElementById('uploadArea');
            const loading = document.getElementById('loading');
            const uploadBtn = document.getElementById('uploadBtn');

            uploadBtn.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (validateImage(file)) {
                    displayPreview(file);
                    uploadFile(file);
                }
            });

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = '#f8f9ff';
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = '';
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = '';
                const file = e.dataTransfer.files[0];
                if (validateImage(file)) {
                    displayPreview(file);
                    uploadFile(file);
                }
            });
        }

        function validateImage(file) {
            if (!file) return false;
            if (!file.type.startsWith('image/')) {
                showStatus('請選擇圖片檔案。', 'error');
                return false;
            }
            if (file.size > 10 * 1024 * 1024) { // 10MB限制
                showStatus('檔案大小不能超過 10MB。', 'error');
                return false;
            }
            return true;
        }

        function displayPreview(file) {
            const reader = new FileReader();
            const imagePreview = document.getElementById('imagePreview');

            reader.onload = function (e) {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.onerror = function (e) {
                console.error('讀取圖片錯誤:', e);
                showStatus('無法顯示預覽。', 'error');
            };
            reader.readAsDataURL(file);
        }

        function uploadFile(file) {
            const loading = document.getElementById('loading');
            const uploadStatus = document.getElementById('uploadStatus');

            loading.style.display = 'block';
            uploadStatus.style.display = 'none';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('username', currentUser); // 加入用戶名

            const apiUrl = 'https://3di4p2vv93.execute-api.us-east-1.amazonaws.com/default/main';

            fetch(apiUrl, {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    loading.style.display = 'none';
                    return response.text().then(text => {
                        try {
                            return JSON.parse(text);
                        } catch {
                            return { message: text };
                        }
                    });
                })
                .then(data => {
                    showStatus('圖片已成功上傳！', 'success');
                    console.log('上傳成功:', data);

                    // 如果在檔案管理分頁，重新載入檔案列表
                    if (document.getElementById('view-tab').classList.contains('active')) {
                        setTimeout(loadFiles, 1000);
                    }
                })
                .catch(err => {
                    loading.style.display = 'none';
                    showStatus('上傳失敗: ' + err.message, 'error');
                    console.error('上傳錯誤:', err);
                });
        }

        function showStatus(message, type) {
            const uploadStatus = document.getElementById('uploadStatus');
            uploadStatus.textContent = message;
            uploadStatus.className = `upload-status ${type}`;
            uploadStatus.style.display = 'block';

            // 3秒後自動隱藏
            setTimeout(() => {
                uploadStatus.style.display = 'none';
            }, 3000);
        }

        async function loadFiles() {
            const filesGrid = document.getElementById('filesGrid');
            const fileCount = document.getElementById('fileCount');

            filesGrid.innerHTML = `
                <div class="empty-state">
                    <div class="loading-spinner"></div>
                    <p>載入檔案中...</p>
                </div>
            `;

            try {
                // 調用後端 API 來獲取用戶的檔案列表
                const response = await fetch(`https://3di4p2vv93.execute-api.us-east-1.amazonaws.com/default/main?username=${currentUser}`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    allFiles = data.files || [];
                } else {
                    console.error('API 響應錯誤:', response.status);
                    allFiles = [];
                }

                displayFiles(allFiles);
                updateFileCount(allFiles.length);

            } catch (error) {
                console.error('載入檔案失敗:', error);
                showStatus('載入檔案失敗，請稍後再試', 'error');
                allFiles = [];
                displayFiles(allFiles);
                updateFileCount(allFiles.length);
            }
        }

        function generateMockFiles() {
            // 這個函數不再需要，因為我們現在使用真實的 API
            return [];
        }

        function displayFiles(files) {
            const filesGrid = document.getElementById('filesGrid');

            if (files.length === 0) {
                filesGrid.innerHTML = `
                    <div class="empty-state">
                        <p>目前沒有檔案</p>
                        <p>請切換到上傳分頁來上傳檔案</p>
                    </div>
                `;
                return;
            }

            filesGrid.innerHTML = files.map(file => `
                <div class="file-card">
                    <img src="${file.url}" alt="${file.name}" class="file-thumbnail" 
                         onclick="viewImage('${file.url}', '${file.name}')">
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${file.size} • ${file.uploadDate}</div>
                        <div class="file-actions">
                            <button class="btn btn-primary" onclick="viewImage('${file.url}', '${file.name}')">檢視</button>
                            <a href="${file.url}" download="${file.name}" class="btn btn-success">下載</a>
                            <button class="btn btn-warning" onclick="renameFilePrompt('${file.name}')">重新命名</button>
                            <button class="btn btn-danger" onclick="deleteFile('${file.name}')">刪除</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateFileCount(count) {
            const fileCount = document.getElementById('fileCount');
            fileCount.textContent = `共 ${count} 個檔案`;
        }

        function filterFiles() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredFiles = allFiles.filter(file =>
                file.name.toLowerCase().includes(searchTerm)
            );
            displayFiles(filteredFiles);
            updateFileCount(filteredFiles.length);
        }

        function viewImage(url, name) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');

            modalImage.src = url;
            modalImage.alt = name;
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        function deleteFile(fileName) {
            if (confirm(`確定要刪除檔案 "${fileName}" 嗎？`)) {
                // 調用後端 API 來刪除檔案
                fetch(`https://3di4p2vv93.execute-api.us-east-1.amazonaws.com/default/main?username=${currentUser}&filename=${encodeURIComponent(fileName)}`, {
                    method: 'DELETE',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            showStatus('檔案刪除成功', 'success');
                            loadFiles(); // 重新載入檔案列表
                        } else {
                            return response.json().then(data => {
                                throw new Error(data.message || '刪除失敗');
                            });
                        }
                    })
                    .catch(error => {
                        console.error('刪除檔案錯誤:', error);
                        showStatus('刪除檔案失敗: ' + error.message, 'error');
                    });
            }
        }

        // 點擊模態框背景關閉
        window.onclick = function (event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // 檔案重新命名
        // 檔案重新命名
        function renameFilePrompt(oldName) {
            // 顯示更友好的重命名對話框
            const newName = prompt(`請輸入新的檔案名稱\n\n原檔名：${oldName}\n\n請注意：\n• 檔名不能包含特殊字符 < > : " | ? * \\ /\n• 檔名長度不能超過 255 個字符`);

            // 輸入驗證
            if (newName === null) {
                // 使用者按了取消
                return;
            }

            if (!newName || newName.trim() === '') {
                showStatus('檔名不能為空', 'error');
                return;
            }

            const trimmedName = newName.trim();

            if (trimmedName === oldName) {
                showStatus('檔名未變更，操作已取消', 'info');
                return;
            }

            // 檔名驗證
            if (!validateFileName(trimmedName)) {
                return;
            }

            // 確認重命名
            if (confirm(`確定要將「${oldName}」重新命名為「${trimmedName}」嗎？`)) {
                renameFile(oldName, trimmedName);
            }
        }

        // 檔名驗證函數
        function validateFileName(fileName) {
            // 檢查檔名長度
            if (fileName.length > 255) {
                showStatus('檔名過長，請限制在 255 個字符以內', 'error');
                return false;
            }

            // 檢查非法字符
            const invalidChars = /[<>:"|?*\\/]/;
            if (invalidChars.test(fileName)) {
                showStatus('檔名不能包含以下字符：< > : " | ? * \\ /', 'error');
                return false;
            }

            // 檢查保留名稱（Windows系統）
            const reservedNames = /^(CON|PRN|AUX|NUL|COM[1-9]|LPT[1-9])(\.|$)/i;
            if (reservedNames.test(fileName)) {
                showStatus('檔名不能使用系統保留名稱', 'error');
                return false;
            }

            // 檔名不能以點開頭或結尾，也不能只包含點和空格
            if (/^\.+$/.test(fileName) || fileName.startsWith('.') && fileName.length === 1) {
                showStatus('檔名格式不正確', 'error');
                return false;
            }

            return true;
        }

        function renameFile(oldName, newName) {
            if (!currentUser) {
                console.error('錯誤：currentUser 未定義');
                showStatus('重新命名失敗：使用者未登入', 'error');
                return;
            }

            // 顯示載入狀態
            showStatus('正在重新命名檔案...', 'info');

            // 設定請求超時
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30秒超時

            fetch(`https://3di4p2vv93.execute-api.us-east-1.amazonaws.com/default/main`, {
                method: 'PUT',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: currentUser,
                    oldName: oldName,
                    newName: newName
                }),
                signal: controller.signal
            })
                .then(response => {
                    clearTimeout(timeoutId);

                    if (response.ok) {
                        return response.json().then(data => {
                            showStatus('檔案重新命名成功', 'success');
                            loadFiles(); // 重新載入檔案列表
                            return data;
                        });
                    } else {
                        return response.json().then(data => {
                            throw new Error(data.message || `HTTP錯誤: ${response.status}`);
                        }).catch(() => {
                            // 如果回應不是JSON格式
                            throw new Error(`重新命名失敗 (HTTP ${response.status})`);
                        });
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    console.error('重新命名錯誤:', error);

                    if (error.name === 'AbortError') {
                        showStatus('重新命名請求超時，請稍後再試', 'error');
                    } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                        showStatus('網路連接錯誤，請檢查網路連接', 'error');
                    } else {
                        showStatus('重新命名失敗: ' + error.message, 'error');
                    }
                });
        }
    </script>
</body>

</html>